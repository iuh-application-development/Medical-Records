{% extends "base.html" %}
{% block title %}Medical Records{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">Medical Records - Patient: {{ patient.full_name }} ({{ patient.username }})</h2>
            {% if records %}
                {% if current_user.role == 'doctor' %}
                <div class="mb-4">
                    <h4>Patient Information:</h4>
                    <p><strong>Name:</strong> {{ patient.full_name }}</p>
                    <p><strong>Email:</strong> {{ patient.email }}</p>
                    <p><strong>Phone:</strong> {{ patient.phone }}</p>
                </div>
                {% endif %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>Date</th>
                                <th>HGB (g/dL)<br><small class="text-muted">12-16</small></th>
                                <th>RBC (M/μL)<br><small class="text-muted">4.2-5.4</small></th>
                                <th>WBC (K/μL)<br><small class="text-muted">4.5-11.0</small></th>
                                <th>PLT (K/μL)<br><small class="text-muted">150-450</small></th>
                                <th>HCT (%)<br><small class="text-muted">36-46</small></th>
                                <th>Glucose (mg/dL)<br><small class="text-muted">70-100</small></th>
                                <th>Creatinine (mg/dL)<br><small class="text-muted">0.7-1.3</small></th>
                                <th>ALT (U/L)<br><small class="text-muted">7-56</small></th>
                                <th>Cholesterol (mg/dL)<br><small class="text-muted">< 200</small></th>
                                <th>CRP (mg/L)<br><small class="text-muted">< 3.0</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                                <td class="{% if record.hgb and (record.hgb < 12 or record.hgb > 16) %}table-danger{% endif %}">{{ record.hgb }}</td>
                                <td class="{% if record.rbc and (record.rbc < 4.2 or record.rbc > 5.4) %}table-danger{% endif %}">{{ record.rbc }}</td>
                                <td class="{% if record.wbc and (record.wbc < 4.5 or record.wbc > 11.0) %}table-danger{% endif %}">{{ record.wbc }}</td>
                                <td class="{% if record.plt and (record.plt < 150 or record.plt > 450) %}table-danger{% endif %}">{{ record.plt }}</td>
                                <td class="{% if record.hct and (record.hct < 36 or record.hct > 46) %}table-danger{% endif %}">{{ record.hct }}</td>
                                <td class="{% if record.glucose and (record.glucose < 70 or record.glucose > 100) %}table-danger{% endif %}">{{ record.glucose }}</td>
                                <td class="{% if record.creatinine and (record.creatinine < 0.7 or record.creatinine > 1.3) %}table-danger{% endif %}">{{ record.creatinine }}</td>
                                <td class="{% if record.alt and (record.alt < 7 or record.alt > 56) %}table-danger{% endif %}">{{ record.alt }}</td>
                                <td class="{% if record.cholesterol and record.cholesterol > 200 %}table-danger{% endif %}">{{ record.cholesterol }}</td>
                                <td class="{% if record.crp and record.crp > 3.0 %}table-danger{% endif %}">{{ record.crp }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if current_user.role == 'doctor' %}
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <a href="{{ url_for('doctor.view_charts', patient_id=patient.id) }}" class="btn btn-info">
                        <i class="fas fa-chart-line"></i> View Charts
                    </a>
                    <a href="{{ url_for('doctor.download_records', patient_id=patient.id) }}" class="btn btn-success">
                        <i class="fas fa-download"></i> Download CSV
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#notificationModal">
                        <i class="fas fa-bell"></i> Send Notification
                    </button>
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-info text-center">
                    No medical records found.
                    {% if current_user.role == 'patient' %}
                    <br>
                    <a href="{{ url_for('patient.new_record') }}" class="btn btn-primary mt-2">Add New Record</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if current_user.role == 'doctor' %}
<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('doctor.send_notification', patient_id=patient.id) }}">
                <div class="modal-body">
                    {{ notification_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ notification_form.message.label(class="form-label") }}
                        {{ notification_form.message(class="form-control", rows=3) }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/your-font-awesome-kit.js"></script>
{% endblock %}